<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Plucker Mobile</title>
    <style>
      body {
        background-color: #1e1e1e;
        color: #f0f0f0;
        font-family: sans-serif;
        margin: 0;
        padding: 0;

        height: 100dvh;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
      }

      /* Fullscreen Viewer */
      #fullscreen-viewer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 99999;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      #fullscreen-viewer img,
      #fullscreen-viewer video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .close-fs-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #555;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        z-index: 100000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .fs-actions {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 25px;
        z-index: 100000;
        background: rgba(40, 40, 40, 0.85);
        padding: 12px 30px;
        border-radius: 50px;
        backdrop-filter: blur(4px);
        border: 1px solid #444;
      }

      .fs-action-btn {
        background: transparent;
        border: none;
        font-size: 28px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }
      .fs-action-btn:active {
        transform: scale(0.9);
      }

      .app-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
      }

      /* Mobile Header */
      .mobile-header {
        background-color: #2a2a2a;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid #333;
        flex-shrink: 0;
      }

      .menu-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        padding: 5px;
      }

      .path-display {
        flex: 1;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #ddd;
      }

      .header-controls {
        display: flex;
        gap: 10px;
      }

      /* Sidebar Drawer */
      .backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 900;
        display: none;
      }
      .backdrop.active {
        display: block;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 80%;
        max-width: 300px;
        background-color: #252525;
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
      }
      .sidebar.open {
        transform: translateX(0);
      }

      .sidebar-header {
        padding: 15px;
        background-color: #2a2a2a;
        border-bottom: 1px solid #333;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .root-select {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        background-color: #333;
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
      }

      .folder-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .folder-item {
        padding: 12px 10px;
        border-bottom: 1px solid #333;
        font-size: 16px;
        display: flex;
        align-items: center;
      }
      .folder-item:active {
        background-color: #3a3a3a;
      }

      /* Main Content */
      .grid-scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        -webkit-overflow-scrolling: touch;
      }

      #gif-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Default mobile */
        gap: 10px;
      }

      @media (min-width: 600px) {
        #gif-container {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      @media (min-width: 800px) {
        #gif-container {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      .gif-wrapper {
        background: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .media-container {
        position: relative;
        width: 100%;
        padding-top: 100%; /* Square aspect ratio for uniformity */
        background: #000;
      }

      .media-item {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .file-info {
        padding: 8px;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background: #252525;
        color: #bbb;
        border-top: 1px solid #333;
      }

      /* Always visible toolbar for mobile */
      .mobile-actions {
        display: flex;
        justify-content: space-around;
        background: #333;
        padding: 8px 0;
      }

      .action-btn {
        background: transparent;
        border: none;
        color: #ccc;
        font-size: 18px;
        padding: 5px 10px;
      }
      .action-btn:active {
        color: white;
        transform: scale(1.1);
      }

      /* Pagination Footer */
      .footer-pagination {
        padding: 15px 10px;
        background: #2a2a2a;
        display: flex;
        justify-content: center;
        align-items: center;

        gap: 10px;
        border-top: 1px solid #333;
        flex-shrink: 0;
        z-index: 50;
        position: relative;
      }

      .pag-btn {
        background: #444;
        border: none;
        color: white;

        padding: 12px 18px;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
      }
      .pag-btn:disabled {
        opacity: 0.5;
        cursor: default;
      }
      .pag-btn:active {
        background: #555;
      }

      /* Collection Select in Sidebar */
      .collection-area {
        padding: 15px;
        border-top: 1px solid #333;
      }
    </style>
  </head>
  <body>
    <!-- Fullscreen Viewer -->
    <div id="fullscreen-viewer">
      <div class="close-fs-btn" onclick="closeFullscreen()">‚úï</div>
      <img id="viewer-img" style="display: none" />
      <video
        id="viewer-video"
        style="display: none"
        autoplay
        loop
        muted
        playsinline
      ></video>

      <div class="fs-actions">
        <button id="fs-save-btn" class="fs-action-btn">üíæ</button>
        <button id="fs-del-btn" class="fs-action-btn" style="color: #ff6b6b">
          üóëÔ∏è
        </button>
      </div>
    </div>

    <!-- Sidebar Drawer -->
    <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span>Navigation</span>
        <button class="menu-btn" onclick="toggleSidebar()">‚úï</button>
      </div>
      <div style="padding: 10px">
        <select
          id="root-select"
          class="root-select"
          onchange="changeRoot()"
        ></select>
      </div>
      <div id="folder-list" class="folder-list"></div>

      <div class="collection-area">
        <div style="margin-bottom: 5px; color: #888">Save Destination:</div>
        <select
          id="collection-select"
          class="root-select"
          onchange="handleCollectionChange()"
        >
          <option value="">(Default)</option>
          <option value="__NEW__">‚ûï Create New...</option>
        </select>
      </div>
    </div>

    <div class="app-container">
      <!-- Mobile Header -->
      <div class="mobile-header">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <div class="path-display" id="path-display">Loading...</div>
      </div>

      <!-- Grid -->
      <div id="grid-scroll" class="grid-scroll-area">
        <div id="gif-container"></div>
      </div>

      <!-- Footer Pagination -->
      <div class="footer-pagination">
        <button type="button" class="pag-btn" onclick="window.firstPage()">
          ‚èÆ
        </button>

        <button type="button" class="pag-btn" onclick="window.prevPage()">
          ‚¨Ö
        </button>

        <span
          id="page-info"
          style="
            font-size: 16px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
          "
          >1 / 1</span
        >

        <button type="button" class="pag-btn" onclick="window.nextPage()">
          ‚û°
        </button>

        <button type="button" class="pag-btn" onclick="window.lastPage()">
          ‚è≠
        </button>
      </div>
    </div>

    <script>
      const container = document.getElementById("gif-container");
      const folderList = document.getElementById("folder-list");
      const rootSelect = document.getElementById("root-select");
      const pathDisplay = document.getElementById("path-display");
      const pageInfo = document.getElementById("page-info");
      const gridScroll = document.getElementById("grid-scroll");
      const collectionSelect = document.getElementById("collection-select");
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("backdrop");

      // Mobile defaults
      let pageSize = 8;
      let currentPage = 1;
      let totalItems = 0;
      let totalPages = 1;

      let currentPath = "";
      let availableRoots = [];

      // Viewer Globals
      let currentViewerIndex = -1;
      const viewer = document.getElementById("fullscreen-viewer");
      const viewerImg = document.getElementById("viewer-img");
      const viewerVideo = document.getElementById("viewer-video");

      const fsSaveBtn = document.getElementById("fs-save-btn");
      const fsDelBtn = document.getElementById("fs-del-btn");

      // Touch handling
      let touchStartX = 0;
      let touchEndX = 0;

      window.nextPage = nextPage;
      window.prevPage = prevPage;
      window.firstPage = firstPage;
      window.lastPage = lastPage;
      window.toggleSidebar = toggleSidebar;
      window.closeFullscreen = closeFullscreen;
      window.changeRoot = changeRoot;
      window.handleCollectionChange = handleCollectionChange;

      function toggleSidebar() {
        sidebar.classList.toggle("open");
        backdrop.classList.toggle("active");
      }

      async function init() {
        try {
          const res = await fetch(
            `/plucker/media-list?subdir=&offset=0&limit=100`,
          );
          const data = await res.json();

          rootSelect.innerHTML = "";
          availableRoots = data.items.filter((i) => i.type === "dir");

          availableRoots.forEach((root) => {
            const opt = document.createElement("option");
            opt.value = root.path;
            opt.textContent = `üìÇ ${root.name}`;
            rootSelect.appendChild(opt);
          });

          const defaultRoot =
            availableRoots.find((r) => r.name === "Output") ||
            availableRoots[0];
          if (defaultRoot) {
            rootSelect.value = defaultRoot.path;
            currentPath = defaultRoot.path;
            await loadPage(1);
          }
          loadCollections();
        } catch (e) {
          console.error("Init failed", e);
        }
      }

      async function loadCollections(selectValue = "") {
        try {
          const res = await fetch("/plucker/collections");
          const data = await res.json();

          collectionSelect.innerHTML = `
                <option value="">(Default)</option>
                <option value="__NEW__">‚ûï Create New...</option>
             `;

          if (data.collections) {
            const createOpt = collectionSelect.querySelector(
              'option[value="__NEW__"]',
            );
            data.collections.forEach((col) => {
              const opt = document.createElement("option");
              opt.value = col;
              opt.textContent = `üìÅ ${col}`;
              collectionSelect.insertBefore(opt, createOpt);
            });
          }
          if (selectValue) collectionSelect.value = selectValue;
        } catch (e) {
          console.error("Collections error", e);
        }
      }

      async function handleCollectionChange() {
        const val = collectionSelect.value;
        if (val === "__NEW__") {
          const name = prompt("Enter new collection name:");
          if (name && name.trim()) {
            try {
              const res = await fetch("/plucker/collections", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name.trim() }),
              });
              const data = await res.json();
              if (data.name) {
                await loadCollections(data.name);
              } else {
                collectionSelect.value = "";
              }
            } catch (e) {
              collectionSelect.value = "";
            }
          } else {
            collectionSelect.value = "";
          }
        }
      }

      function changeRoot() {
        currentPath = rootSelect.value;
        toggleSidebar(); // Close on selection
        loadPage(1);
      }

      async function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (e) {}
        }
        // Fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        } catch (e) {
          document.body.removeChild(ta);
          return false;
        }
      }

      function updatePathDisplay() {
        pathDisplay.textContent = currentPath
          .replace("Output/", "")
          .replace("Input/", "");
        if (pathDisplay.textContent === "") pathDisplay.textContent = "Root";
      }

      async function loadPage(displayPageNumber) {
        if (!currentPath) return;

        console.log(`Loading page ${displayPageNumber}`);

        updatePathDisplay();
        gridScroll.scrollTop = 0;

        const zeroIndexedPage = displayPageNumber - 1;
        const url = `/plucker/media-list?subdir=${encodeURIComponent(currentPath)}&offset=${zeroIndexedPage * pageSize}&limit=${pageSize}`;

        try {
          const res = await fetch(url);
          const data = await res.json();

          totalItems = data.total;
          totalPages = Math.ceil(totalItems / pageSize) || 1;
          currentPage = Math.max(1, Math.min(displayPageNumber, totalPages));

          pageInfo.textContent = `${currentPage} / ${totalPages}`;

          console.log(
            `Pages: ${totalPages}, Current: ${currentPage}, Items: ${totalItems}`,
          );

          renderItems(data.items);
        } catch (err) {
          console.error("Error loading page:", err);
        }
      }

      function renderItems(items) {
        container.innerHTML = "";
        folderList.innerHTML = "";

        const dirs = items.filter((i) => i.type === "dir");
        const files = items.filter((i) => i.type !== "dir");

        // Add "Up" folder if not in root
        if (currentPath.split("/").length > 1) {
          const upDiv = document.createElement("div");
          upDiv.className = "folder-item";
          upDiv.innerHTML = "üîô ..";
          upDiv.onclick = () => {
            const parts = currentPath.split("/");
            parts.pop();
            currentPath = parts.join("/");
            loadPage(1);
          };
          folderList.appendChild(upDiv);
        }

        if (dirs.length === 0 && files.length === 0) {
          container.innerHTML =
            '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#666;">Empty</div>';
          return;
        }

        dirs.forEach((dir) => {
          const div = document.createElement("div");
          div.className = "folder-item";
          div.innerHTML = `<span style="margin-right:10px">üìÅ</span> ${dir.name}`;
          div.onclick = () => {
            currentPath = dir.path;
            loadPage(1);
          };
          folderList.appendChild(div);
        });

        files.forEach((fileItem) => {
          createGridItem(fileItem);
        });
      }

      function createGridItem(item) {
        const wrapper = document.createElement("div");
        wrapper.className = "gif-wrapper";

        const mediaUrl = `/plucker/files/${item.path}`;
        const ext = item.path.split(".").pop().toLowerCase();

        const mediaContainer = document.createElement("div");
        mediaContainer.className = "media-container";

        let media;
        if (ext === "mp4") {
          media = document.createElement("video");
          media.autoplay = true;
          media.muted = true;
          media.loop = true;
          media.playsInline = true;
          media.src = mediaUrl;
        } else {
          media = document.createElement("img");
          media.src = mediaUrl;
        }
        media.className = "media-item";

        media.dataset.path = item.path;

        media.onclick = () => {
          const allMedia = Array.from(document.querySelectorAll(".media-item"));
          const idx = allMedia.indexOf(media);
          openFullscreenViewer(idx);
        };

        mediaContainer.appendChild(media);
        wrapper.appendChild(mediaContainer);

        // File Info
        const info = document.createElement("div");
        info.className = "file-info";
        info.textContent = item.name;
        wrapper.appendChild(info);

        // Actions Toolbar
        const actions = document.createElement("div");
        actions.className = "mobile-actions";

        const saveBtn = createBtn("üíæ", () =>
          saveFile(item.path, saveBtn, wrapper),
        );
        const metaBtn = createBtn("üìã", () =>
          copyMetadata(item.path, null, metaBtn, "üìã"),
        );
        const promptBtn = createBtn("üìù", () =>
          copyMetadata(item.path, "prompt_text", promptBtn, "üìù"),
        );
        const delBtn = createBtn("üóëÔ∏è", () => {
          if (confirm("Delete file?")) deleteFile(item.path, wrapper);
        });
        delBtn.style.color = "#ff6b6b";

        actions.appendChild(saveBtn);
        actions.appendChild(metaBtn);
        actions.appendChild(promptBtn);
        actions.appendChild(delBtn);

        wrapper.appendChild(actions);
        container.appendChild(wrapper);
      }

      function createBtn(icon, onClick) {
        const btn = document.createElement("button");
        btn.className = "action-btn";
        btn.textContent = icon;
        btn.onclick = (e) => {
          e.stopPropagation();
          onClick();
        };
        return btn;
      }

      function deleteFile(path, wrapper) {
        fetch(`/plucker/delete?filename=${encodeURIComponent(path)}`, {
          method: "DELETE",
        }).then((res) => {
          if (res.ok) {
            if (wrapper) wrapper.remove();
            // If we are deleting from FS viewer, close it
            if (viewer.style.display !== "none") closeFullscreen();
          }
        });
      }

      function saveFile(path, btn, wrapper) {
        const collection = collectionSelect.value;
        let url = `/plucker/save?filename=${encodeURIComponent(path)}`;
        if (collection && collection !== "__NEW__")
          url += `&collection=${encodeURIComponent(collection)}`;

        btn.textContent = "‚è≥";
        fetch(url, { method: "POST" }).then((res) => {
          if (res.ok) {
            btn.textContent = "‚úÖ";
            setTimeout(() => {
              if (wrapper) wrapper.remove();
              // If saved from FS viewer (file moved), close FS
              if (viewer.style.display !== "none") closeFullscreen();
            }, 500);
          } else {
            btn.textContent = "‚ùå";
            setTimeout(() => (btn.textContent = "üíæ"), 1500);
          }
        });
      }

      function copyMetadata(filepath, key, btn, originalIcon) {
        btn.textContent = "‚è≥";
        let url = `/plucker/metadata?filename=${encodeURIComponent(filepath)}`;
        if (key) url += `&key=${key}`;

        fetch(url)
          .then((r) => r.json())
          .then((data) => {
            const text =
              data.metadata && typeof data.metadata === "object"
                ? JSON.stringify(data.metadata, null, 2)
                : data.metadata;
            if (text) {
              copyToClipboard(text).then((ok) => {
                btn.textContent = ok ? "‚úÖ" : "‚ö†Ô∏è";
                setTimeout(() => (btn.textContent = originalIcon), 1500);
              });
            } else {
              btn.textContent = "üö´";
              setTimeout(() => (btn.textContent = originalIcon), 1500);
            }
          });
      }

      // Viewer Logic
      function openFullscreenViewer(index) {
        currentViewerIndex = index;
        const allMedia = Array.from(document.querySelectorAll(".media-item"));
        if (!allMedia[index]) return;

        const currentMedia = allMedia[index];
        const src = currentMedia.src;
        const isVideo = currentMedia.tagName === "VIDEO";
        const path = currentMedia.dataset.path;

        const wrapper = currentMedia.closest(".gif-wrapper");

        fsSaveBtn.textContent = "üíæ";
        fsSaveBtn.onclick = (e) => {
          e.stopPropagation();
          saveFile(path, fsSaveBtn, wrapper);
        };

        fsDelBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm("Delete this file?")) {
            deleteFile(path, wrapper);
          }
        };

        viewer.style.display = "flex";
        if (isVideo) {
          viewerImg.style.display = "none";
          viewerVideo.style.display = "block";
          viewerVideo.src = src;
        } else {
          viewerVideo.style.display = "none";
          viewerVideo.pause();
          viewerImg.style.display = "block";
          viewerImg.src = src;
        }
      }

      function closeFullscreen() {
        viewer.style.display = "none";
        viewerVideo.pause();
      }

      // Swipe Gestures
      viewer.addEventListener("touchstart", (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });
      viewer.addEventListener("touchend", (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });

      function handleSwipe() {
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          // threshold
          if (diff > 0) {
            // Swipe Left -> Next
            const all = document.querySelectorAll(".media-item");
            if (currentViewerIndex < all.length - 1)
              openFullscreenViewer(currentViewerIndex + 1);
            else if (currentPage < totalPages) {
              nextPage().then(() => openFullscreenViewer(0));
            }
          } else {
            // Swipe Right -> Prev

            if (currentViewerIndex > 0) {
              openFullscreenViewer(currentViewerIndex - 1);
            } else if (currentPage > 1) {
              prevPage().then(() => {
                // Re-query items after page load
                const newItems = document.querySelectorAll(".media-item");
                if (newItems.length > 0) {
                  openFullscreenViewer(newItems.length - 1);
                }
              });
            }
          }
        }
      }

      function nextPage() {
        console.log(
          "Navigating Next. Current:",
          currentPage,
          "Total:",
          totalPages,
        );
        if (currentPage < totalPages) return loadPage(currentPage + 1);
        return Promise.resolve();
      }

      function prevPage() {
        console.log("Navigating Prev. Current:", currentPage);
        if (currentPage > 1) return loadPage(currentPage - 1);
        return Promise.resolve();
      }

      function firstPage() {
        console.log("Navigating First");
        if (currentPage > 1) return loadPage(1);
        return Promise.resolve();
      }

      function lastPage() {
        console.log("Navigating Last");
        if (currentPage < totalPages) return loadPage(totalPages);
        return Promise.resolve();
      }

      window.onload = init;
    </script>
  </body>
</html>
