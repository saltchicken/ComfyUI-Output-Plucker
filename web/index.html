<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Output Plucker</title>
    <style>
      body {
        background-color: #1e1e1e;
        color: #f0f0f0;
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }

      .app-container {
        display: flex;
        height: 100%;
        width: 100%;
      }

      .sidebar {
        width: 240px;
        background-color: #252525;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #333;
        background-color: #2a2a2a;
      }

      .root-select {
        width: 100%;
        padding: 8px;
        background-color: #333;
        color: #fff;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .folder-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .folder-item {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        cursor: pointer;
        border-radius: 4px;
        color: #ccc;
        margin-bottom: 2px;
        transition: background 0.2s;
        font-size: 14px;
      }

      .folder-item:hover {
        background-color: #3a3a3a;
        color: #fff;
      }

      .folder-icon {
        margin-right: 8px;
        font-size: 16px;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0; /* Fix flex child overflow issues */
      }

      .top-bar {
        padding: 10px 20px;
        background-color: #2a2a2a;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .breadcrumbs {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #888;
        overflow: hidden;
        white-space: nowrap;
      }

      .breadcrumb-item {
        cursor: pointer;
        color: #88ccff;
        margin: 0 5px;
      }

      .breadcrumb-item:hover {
        text-decoration: underline;
      }

      .breadcrumb-separator {
        color: #555;
      }

      .controls {
        display: flex;
        gap: 5px;
        align-items: center;
      }

      .controls button,
      .controls select {
        padding: 6px 12px;
        font-size: 13px;
        background: #444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      #collection-select {
        background-color: #2c3e50;
        border: 1px solid #34495e;
        min-width: 120px;
      }

      .controls button:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .grid-scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      #gif-container {
        /* Grid layout for images */
        display: flex;
        flex-wrap: wrap;

        --grid-gap: 15px;
        --grid-cols: 3;

        gap: var(--grid-gap);
        align-content: flex-start;
      }

      .gif-wrapper {
        position: relative;

        width: calc(
          (100% - (var(--grid-cols) - 1) * var(--grid-gap)) / var(--grid-cols)
        );

        min-width: 0;

        background: #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .gif-wrapper img,
      .gif-wrapper video {
        width: 100%;
        height: auto;
        display: block;
        cursor: pointer;
        /* aspect-ratio: 1;  Optional: forces square grid */
        object-fit: contain;
        background: #000;
        min-height: 150px;
      }

      /* Action overlay styles (kept from original) */
      .delete-icon {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        font-size: 16px;
        padding: 5px;
        border-radius: 4px;
        cursor: pointer;
        display: none;
        z-index: 10;
      }
      .gif-wrapper:hover .delete-icon {
        display: block;
      }

      .action-bar-left {
        position: absolute;
        top: 5px;
        left: 5px;
        display: flex;
        gap: 5px;
        z-index: 10;
      }

      .action-btn {
        background: rgba(0, 0, 0, 0.6);
        font-size: 16px;
        padding: 5px;
        border-radius: 4px;
        cursor: pointer;
        display: none;
        width: 24px;
        height: 24px;
        text-align: center;
        line-height: 24px;
      }
      .gif-wrapper:hover .action-btn {
        display: block;
      }

      .save-icon {
        color: #4caf50;
      }
      .meta-icon {
        color: #2196f3;
      }
      .prompt-icon {
        color: #ff9800;
      }
      .path-icon {
        color: #9c27b0;
      }

      .file-label {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        font-size: 11px;
        padding: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
      }
      .gif-wrapper:hover .file-label {
        opacity: 1;
      }

      .page-info {
        font-size: 13px;
        color: #aaa;
        margin: 0 10px;
      }

      .empty-message {
        width: 100%;
        text-align: center;
        color: #555;
        margin-top: 50px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="sidebar">
        <div class="sidebar-header">
          <label
            style="
              font-size: 12px;
              color: #888;
              display: block;
              margin-bottom: 5px;
            "
            >Source</label
          >
          <select id="root-select" class="root-select" onchange="changeRoot()">
            <option value="" disabled selected>Loading...</option>
          </select>
        </div>
        <div id="folder-list" class="folder-list">
          <!-- Folders injected here -->
        </div>
      </div>

      <div class="main-content">
        <div class="top-bar">
          <div id="breadcrumbs" class="breadcrumbs">
            <!-- Breadcrumbs injected here -->
          </div>

          <div class="controls">
            <span style="font-size: 12px; color: #888">Save to:</span>
            <select id="collection-select" onchange="handleCollectionChange()">
              <option value="">(Default)</option>
              <option value="__NEW__">‚ûï Create New...</option>
            </select>

            <div
              style="width: 1px; height: 20px; background: #444; margin: 0 5px"
            ></div>

            <span style="font-size: 12px; color: #888">Grid:</span>
            <select id="col-count-select" onchange="updateGridSettings()">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="8">8</option>
            </select>
            <span style="font-size: 12px; color: #888">x</span>
            <select id="row-count-select" onchange="updateGridSettings()">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="8">8</option>
              <option value="10">10</option>
              <option value="12">12</option>
            </select>

            <div
              style="width: 1px; height: 20px; background: #444; margin: 0 5px"
            ></div>

            <button onclick="firstPage()">‚èÆ</button>
            <button onclick="prevPage()">‚¨Ö</button>
            <span class="page-info" id="page-info">1 / 1</span>
            <button onclick="nextPage()">‚û°</button>
            <button onclick="lastPage()">‚è≠</button>
          </div>
        </div>

        <div id="grid-scroll" class="grid-scroll-area">
          <div id="gif-container"></div>
        </div>
      </div>
    </div>

    <script>
      const container = document.getElementById("gif-container");
      const folderList = document.getElementById("folder-list");
      const rootSelect = document.getElementById("root-select");
      const breadcrumbsContainer = document.getElementById("breadcrumbs");
      const pageInfo = document.getElementById("page-info");
      const gridScroll = document.getElementById("grid-scroll");

      const collectionSelect = document.getElementById("collection-select");

      const colCountSelect = document.getElementById("col-count-select");

      const rowCountSelect = document.getElementById("row-count-select");

      let pageSize = 12;
      let currentPage = 1;
      let totalItems = 0;
      let totalPages = 1;

      let currentPath = "";
      let availableRoots = [];

      async function init() {
        try {
          const savedCols = localStorage.getItem("plucker_columns");
          if (savedCols) {
            colCountSelect.value = savedCols;
          }

          const savedRows = localStorage.getItem("plucker_rows");
          if (savedRows) {
            rowCountSelect.value = savedRows;
          }

          updateGridSettings(false);

          const res = await fetch(
            `/plucker/media-list?subdir=&offset=0&limit=100`,
          );
          const data = await res.json();

          // Populate Dropdown
          rootSelect.innerHTML = "";
          availableRoots = data.items.filter((i) => i.type === "dir");

          availableRoots.forEach((root) => {
            const opt = document.createElement("option");
            opt.value = root.path;
            opt.textContent = `üìÇ ${root.name}`;
            rootSelect.appendChild(opt);
          });

          // Default to "Output" if available, else first item
          const defaultRoot =
            availableRoots.find((r) => r.name === "Output") ||
            availableRoots[0];
          if (defaultRoot) {
            rootSelect.value = defaultRoot.path;
            currentPath = defaultRoot.path;
            loadPage(1);
          }

          loadCollections();
        } catch (e) {
          console.error("Failed to init roots", e);
        }
      }

      function updateGridSettings(shouldReload = true) {
        const cols = parseInt(colCountSelect.value, 10);
        const rows = parseInt(rowCountSelect.value, 10);

        // Update CSS variable for grid layout
        container.style.setProperty("--grid-cols", cols);

        // Calculate page size dynamically
        pageSize = cols * rows;

        // Save preferences
        localStorage.setItem("plucker_columns", cols);
        localStorage.setItem("plucker_rows", rows);

        if (shouldReload) {
          currentPage = 1;
          loadPage(1);
        }
      }

      async function loadCollections(selectValue = "") {
        try {
          const res = await fetch("/plucker/collections");
          const data = await res.json();

          // Keep "Default" and "Create New" options
          collectionSelect.innerHTML = `
                <option value="">(Default)</option>
                <option value="__NEW__">‚ûï Create New...</option>
             `;

          if (data.collections) {
            // Insert collections before "Create New"
            const createOpt = collectionSelect.querySelector(
              'option[value="__NEW__"]',
            );

            data.collections.forEach((col) => {
              const opt = document.createElement("option");
              opt.value = col;
              opt.textContent = `üìÅ ${col}`;
              collectionSelect.insertBefore(opt, createOpt);
            });
          }

          if (selectValue) {
            collectionSelect.value = selectValue;
          }
        } catch (e) {
          console.error("Failed to load collections", e);
        }
      }

      async function handleCollectionChange() {
        const val = collectionSelect.value;
        if (val === "__NEW__") {
          const name = prompt("Enter new collection name:");
          if (name && name.trim()) {
            try {
              const res = await fetch("/plucker/collections", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name.trim() }),
              });
              const data = await res.json();
              if (data.name) {
                await loadCollections(data.name); // Reload and select new
              } else {
                alert(data.error || "Failed to create");
                collectionSelect.value = "";
              }
            } catch (e) {
              alert("Error creating collection");
              collectionSelect.value = "";
            }
          } else {
            collectionSelect.value = ""; // Reset if cancelled
          }
        }
      }

      function changeRoot() {
        currentPath = rootSelect.value;
        currentPage = 1;
        loadPage(1);
      }

      function isRoot(path) {
        return availableRoots.some((r) => r.path === path);
      }

      async function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (err) {}
        }
        try {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.select();
          const successful = document.execCommand("copy");
          document.body.removeChild(textArea);
          return successful;
        } catch (err) {
          return false;
        }
      }

      function toggleFullscreen(elem) {
        if (!document.fullscreenElement) {
          elem.requestFullscreen?.();
        } else {
          document.exitFullscreen?.();
        }
      }

      function updateBreadcrumbs() {
        breadcrumbsContainer.innerHTML = "";

        if (!currentPath) return;

        const parts = currentPath.split("/"); // e.g., ["Output", "Saved", "Batch1"]

        let buildPath = "";

        parts.forEach((part, index) => {
          if (index > 0) {
            const sep = document.createElement("span");
            sep.className = "breadcrumb-separator";
            sep.textContent = " ‚Ä∫ ";
            breadcrumbsContainer.appendChild(sep);
            buildPath += "/" + part;
          } else {
            buildPath = part;
          }

          const item = document.createElement("span");
          item.className = "breadcrumb-item";

          // Add icon for root
          if (index === 0) item.textContent = "üè† " + part;
          else item.textContent = part;

          // Click handler closure
          const targetPath = buildPath;
          item.onclick = () => {
            currentPath = targetPath;
            loadPage(1);
          };

          breadcrumbsContainer.appendChild(item);
        });
      }

      function renderItems(items) {
        container.innerHTML = "";
        folderList.innerHTML = "";

        // Split items
        const dirs = items.filter((i) => i.type === "dir");
        const files = items.filter((i) => i.type !== "dir");

        // 1. Render Sidebar Folders
        if (dirs.length === 0) {
          folderList.innerHTML =
            '<div style="color: #555; font-style:italic; padding:10px; font-size:12px;">No subfolders</div>';
        } else {
          dirs.forEach((dir) => {
            const div = document.createElement("div");
            div.className = "folder-item";
            div.innerHTML = `<span class="folder-icon">üìÅ</span> ${dir.name}`;
            div.onclick = () => {
              currentPath = dir.path;
              loadPage(1);
            };
            folderList.appendChild(div);
          });
        }

        // 2. Render Main Grid Files
        if (files.length === 0 && dirs.length === 0) {
          container.innerHTML =
            '<div class="empty-message">Empty Directory</div>';
          return;
        }

        files.forEach((fileItem) => {
          createGridItem(fileItem);
        });

        // Intersection observer for lazy loading images
        document
          .querySelectorAll(".lazy-load")
          .forEach((img) => observer.observe(img));
      }

      const observer = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const media = entry.target;
              if (media.dataset.src) {
                media.src = media.dataset.src;
                media.classList.remove("lazy-load");
                obs.unobserve(media);
              }
            }
          });
        },
        { root: gridScroll, rootMargin: "0px 0px 200px 0px", threshold: 0.1 },
      );

      function createGridItem(item) {
        const wrapper = document.createElement("div");
        wrapper.className = "gif-wrapper";

        const file = item.path;
        const ext = file.split(".").pop().toLowerCase();
        let media;
        const mediaUrl = `/plucker/files/${file}`;

        if (ext === "mp4") {
          media = document.createElement("video");
          media.autoplay = true;
          media.muted = true;
          media.loop = true;
          media.dataset.src = mediaUrl;
          media.className = "lazy-load";
        } else {
          media = document.createElement("img");
          media.dataset.src = mediaUrl;
          media.className = "lazy-load";
        }

        media.alt = item.name;
        media.ondblclick = (e) => {
          e.stopPropagation();
          toggleFullscreen(media);
        };

        wrapper.appendChild(media);

        // --- Actions (Same as before) ---

        // Delete
        const delBtn = document.createElement("div");
        delBtn.className = "delete-icon";
        delBtn.textContent = "üóëÔ∏è";
        delBtn.title = "Delete";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`Delete ${item.name}?`)) deleteFile(item.path, wrapper);
        };
        wrapper.appendChild(delBtn);

        // Action Bar
        const bar = document.createElement("div");
        bar.className = "action-bar-left";

        // Save
        const saveBtn = createActionBtn("üíæ", "save-icon", "Save", () =>
          saveFile(item.path, saveBtn, wrapper),
        );
        bar.appendChild(saveBtn);

        // Meta
        const metaBtn = createActionBtn(
          "üìã",
          "meta-icon",
          "Copy Metadata",
          () => copyMetadata(item.path, null, metaBtn, "üìã"),
        );
        bar.appendChild(metaBtn);

        // Prompt
        const promptBtn = createActionBtn(
          "üìù",
          "prompt-icon",
          "Copy Prompt",
          () => copyMetadata(item.path, "prompt_text", promptBtn, "üìù"),
        );
        bar.appendChild(promptBtn);

        // Path
        const pathBtn = createActionBtn("üîó", "path-icon", "Copy Path", () =>
          copyPath(item.fullpath, pathBtn),
        );
        bar.appendChild(pathBtn);

        wrapper.appendChild(bar);

        // Label
        const label = document.createElement("div");
        label.className = "file-label";
        label.textContent = item.name;
        wrapper.appendChild(label);

        container.appendChild(wrapper);
      }

      function createActionBtn(icon, extraClass, title, onClick) {
        const div = document.createElement("div");
        div.className = `action-btn ${extraClass}`;
        div.textContent = icon;
        div.title = title;
        div.onclick = (e) => {
          e.stopPropagation();
          onClick();
        };
        return div;
      }

      // --- API Calls ---

      function deleteFile(path, wrapper) {
        fetch(`/plucker/delete?filename=${encodeURIComponent(path)}`, {
          method: "DELETE",
        }).then((res) => {
          if (res.ok) wrapper.remove();
          else alert("Error deleting");
        });
      }

      function saveFile(path, btn, wrapper) {
        const collection = collectionSelect.value;
        let url = `/plucker/save?filename=${encodeURIComponent(path)}`;
        if (collection && collection !== "__NEW__") {
          url += `&collection=${encodeURIComponent(collection)}`;
        }

        btn.textContent = "‚è≥";
        fetch(url, {
          method: "POST",
        }).then((res) => {
          if (res.ok) {
            if (wrapper) wrapper.remove();
          } else {
            btn.textContent = "‚ùå";
            setTimeout(() => (btn.textContent = "üíæ"), 1500);
          }
        });
      }

      function copyPath(fullpath, btn) {
        btn.textContent = "‚è≥";
        copyToClipboard(fullpath).then((ok) => {
          btn.textContent = ok ? "‚úÖ" : "‚ùå";
          setTimeout(() => (btn.textContent = "üîó"), 1500);
        });
      }

      function copyMetadata(filepath, key, btn, originalIcon) {
        btn.textContent = "‚è≥";
        let url = `/plucker/metadata?filename=${encodeURIComponent(filepath)}`;
        if (key) url += `&key=${key}`;

        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            if (data.metadata) {
              const text =
                typeof data.metadata === "object"
                  ? JSON.stringify(data.metadata, null, 2)
                  : data.metadata;
              copyToClipboard(text).then((success) => {
                btn.textContent = success ? "‚úÖ" : "‚ö†Ô∏è";
                setTimeout(() => (btn.textContent = originalIcon), 1500);
              });
            } else {
              btn.textContent = "üö´";
              setTimeout(() => (btn.textContent = originalIcon), 1500);
            }
          })
          .catch(() => {
            btn.textContent = "‚ùå";
            setTimeout(() => (btn.textContent = originalIcon), 1500);
          });
      }

      function loadPage(displayPageNumber) {
        if (!currentPath) return; // Wait for init

        const rootPart = currentPath.split("/")[0];
        if (
          rootSelect.value !== rootPart &&
          availableRoots.some((r) => r.name === rootPart)
        ) {
          rootSelect.value = rootPart; // Visual sync only
        }

        updateBreadcrumbs();
        gridScroll.scrollTop = 0; // Reset scroll

        const zeroIndexedPage = displayPageNumber - 1;
        const url = `/plucker/media-list?subdir=${encodeURIComponent(currentPath)}&offset=${zeroIndexedPage * pageSize}&limit=${pageSize}`;

        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            totalItems = data.total;
            totalPages = Math.ceil(totalItems / pageSize);
            currentPage = Math.max(
              1,
              Math.min(displayPageNumber, totalPages || 1),
            );

            pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;

            renderItems(data.items);
          })
          .catch((err) => console.error("Error loading page:", err));
      }

      function nextPage() {
        if (currentPage < totalPages) loadPage(currentPage + 1);
      }
      function prevPage() {
        if (currentPage > 1) loadPage(currentPage - 1);
      }
      function firstPage() {
        loadPage(1);
      }
      function lastPage() {
        loadPage(totalPages);
      }


      window.addEventListener("keydown", (e) => {
        // Don't trigger if user is interacting with inputs/selects to avoid changing selection
        const tag = document.activeElement.tagName;
        if (tag === "INPUT" || tag === "SELECT" || tag === "TEXTAREA") return;

        if (e.key === "ArrowLeft") {
          prevPage();
        } else if (e.key === "ArrowRight") {
          nextPage();
        }
      });

      window.onload = init;
    </script>
  </body>
</html>